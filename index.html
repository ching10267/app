<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>行事曆 - 本機儲存</title>
    <!-- 載入 Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 載入 Google Fonts - Inter for clean text -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* 簡約俐落的字體和基礎設定 */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7; /* 極淺灰，比純白柔和 */
            color: #1f2937; /* 深黑灰 */
        }
        .container-mobile {
            max-width: 600px;
            margin: 0 auto;
            min-height: 100vh;
            background-color: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
        }
        .day-cell {
            min-height: 80px; /* 增加手機上的觸控區和內容空間 */
            cursor: pointer;
            transition: background-color 0.15s;
        }
        .day-cell:hover:not(.empty-day) {
            background-color: #f3f4f6;
        }
        .event-tag {
            font-size: 0.75rem;
            padding: 2px 6px;
            margin-top: 2px;
            border-radius: 4px;
            max-width: 100%;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            /* 增加過渡效果使顏色切換更平滑 */
            transition: background-color 0.2s, border-color 0.2s; 
        }
        /* 優化後的顏色定義 (6種) - 使用較強的背景色和邊框 */
        .color-A { @apply bg-blue-200 text-blue-800 border-blue-300; }
        .color-B { @apply bg-emerald-200 text-emerald-800 border-emerald-300; }
        .color-C { @apply bg-violet-200 text-violet-800 border-violet-300; }
        .color-D { @apply bg-amber-200 text-amber-800 border-amber-300; }
        .color-E { @apply bg-red-200 text-red-800 border-red-300; } /* 使用更明確的 red */
        .color-F { @apply bg-gray-300 text-gray-800 border-gray-400; }

        /* 隱藏滾動條，保持整潔 */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }
        
        /* 修正：強制顏色選擇器容器使用 Flex 佈局 */
        #color-picker {
            display: flex;
        }
    </style>
</head>
<body>

<div class="container-mobile flex flex-col">
    <!-- 標題與用戶資訊 -->
    <header class="p-4 border-b border-gray-200 sticky top-0 bg-white z-10 rounded-b-lg">
        <h1 class="text-2xl font-bold text-center">行事曆 (本機儲存)</h1>
        <!-- 狀態: 用於顯示儲存成功/失敗訊息 -->
        <p id="user-info" class="text-xs text-gray-500 mt-1 truncate transition-opacity duration-300 opacity-100 h-auto">
            狀態: 資料已儲存於您的瀏覽器中 (localStorage)
        </p>
    </header>

    <!-- 導覽列 (月份切換) -->
    <div class="flex items-center justify-between p-4 bg-gray-50 border-b border-gray-200">
        <button id="prev-month" class="p-2 rounded-full hover:bg-gray-200 transition" aria-label="上個月">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
        </button>
        <span id="current-month-year" class="text-lg font-semibold">2023年 10月</span>
        <button id="next-month" class="p-2 rounded-full hover:bg-gray-200 transition" aria-label="下個月">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
        </button>
    </div>

    <!-- 星期標頭 -->
    <div id="week-header" class="grid grid-cols-7 text-center text-sm font-medium text-gray-500 border-b border-gray-200">
        <div class="py-2">日</div>
        <div class="py-2">一</div>
        <div class="py-2">二</div>
        <div class="py-2">三</div>
        <div class="py-2">四</div>
        <div class="py-2">五</div>
        <div class="py-2">六</div>
    </div>

    <!-- 日曆網格 -->
    <div id="calendar-grid" class="grid grid-cols-7 flex-grow hide-scrollbar overflow-y-auto">
        <!-- 日期格將由 JavaScript 渲染 -->
    </div>

    <!-- 新增事件按鈕 (現在始終啟用) -->
    <div class="p-4 sticky bottom-0 bg-white border-t border-gray-200 z-10 rounded-t-lg">
        <button id="add-event-btn" 
                class="w-full bg-black text-white p-3 rounded-xl font-semibold shadow-lg transition hover:bg-gray-800">
            + 新增行程
        </button>
    </div>
</div>

<!-- 事件新增/編輯 Modal -->
<div id="event-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden transition-opacity" aria-hidden="true">
    <div class="bg-white w-full max-w-sm p-6 rounded-xl shadow-2xl transform transition-all duration-300">
        <h2 id="modal-title" class="text-xl font-bold mb-4">新增行程</h2>
        <form id="event-form">
            
            <!-- 日期選擇 -->
            <div class="mb-4">
                <label for="event-date" class="block text-sm font-medium text-gray-700 mb-1">日期</label>
                <input type="date" id="event-date" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-black focus:border-black transition">
            </div>

            <!-- 行程內容 -->
            <div class="mb-4">
                <label for="event-title" class="block text-sm font-medium text-gray-700 mb-1">行程內容</label>
                <input type="text" id="event-title" placeholder="輸入行程標題" required maxlength="50" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-black focus:border-black transition">
            </div>

            <!-- 顏色色塊選擇 -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">顏色標籤</label>
                <div id="color-picker" class="flex flex-wrap gap-3">
                    <!-- Color Options will be injected by JS -->
                </div>
                <input type="hidden" id="event-color" required>
            </div>

            <div class="flex flex-col space-y-3">
                <!-- 儲存按鈕 (現在始終啟用) -->
                <button type="submit" id="save-event-btn" 
                        class="w-full bg-black text-white p-3 rounded-xl font-semibold hover:bg-gray-800 transition">
                    儲存
                </button>
                <button type="button" id="close-modal-btn" class="w-full bg-gray-100 text-gray-800 p-3 rounded-xl font-medium hover:bg-gray-200 transition">
                    取消
                </button>
                <!-- 刪除按鈕只在編輯模式顯示 -->
                <button type="button" id="delete-event-btn" class="w-full bg-rose-500 text-white p-3 rounded-xl font-semibold hover:bg-rose-600 transition hidden">
                    刪除行程
                </button>
            </div>
        </form>
    </div>
</div>

<!-- 自定義刪除確認 Modal (取代 window.confirm) -->
<div id="delete-confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden transition-opacity" aria-hidden="true">
    <div class="bg-white w-full max-w-xs p-6 rounded-xl shadow-2xl transform transition-all duration-300">
        <h2 class="text-xl font-bold mb-4">確認刪除</h2>
        <p class="mb-6 text-gray-700">您確定要刪除這個行程嗎？此操作無法復原。</p>
        <div class="flex justify-end space-x-3">
            <button type="button" id="cancel-delete-btn" class="w-1/2 bg-gray-100 text-gray-800 p-3 rounded-xl font-medium hover:bg-gray-200 transition">
                取消
            </button>
            <button type="button" id="confirm-delete-btn" class="w-1/2 bg-rose-500 text-white p-3 rounded-xl font-semibold hover:bg-rose-600 transition">
                確定刪除
            </button>
        </div>
    </div>
</div>

<!-- 移除 Firebase 相關程式碼，改用 LocalStorage -->
<script type="module">
    // --- App State ---
    const state = {
        currentDate: new Date(),
        events: {}, // Key: "YYYY-MM-DD", Value: Array of events
        modalOpen: false,
        editingEventId: null,
        eventIdToDelete: null,
    };

    // 6種優化後的顏色
    const COLORS = [
        { id: 'A', class: 'color-A', name: '藍色標籤' },
        { id: 'B', class: 'color-B', name: '綠色標籤' },
        { id: 'C', 'class': 'color-C', name: '紫色標籤' },
        { id: 'D', class: 'color-D', name: '黃色標籤' },
        { id: 'E', class: 'color-E', name: '紅色標籤' },
        { id: 'F', class: 'color-F', name: '灰色標籤' }
    ];

    // --- Utility Functions ---

    /** 格式化日期為 YYYY-MM-DD 字符串 */
    const formatDate = (date) => {
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
    };

    /** 生成一個簡單的唯一 ID */
    const generateUniqueId = () => {
        // 使用時間戳和隨機數生成一個近似唯一的 ID
        return Date.now().toString(36) + Math.random().toString(36).substring(2, 9);
    };

    /** 處理 LocalStorage 錯誤或自定義提示 */
    const alertUser = (message, isError = true) => {
        const userInfo = document.getElementById('user-info');
        // 替換或添加新訊息
        userInfo.textContent = message;
        userInfo.classList.remove('text-gray-500', 'text-rose-500', 'text-green-500');
        userInfo.classList.add(isError ? 'text-rose-500' : 'text-green-500');

        // 自動隱藏訊息
        setTimeout(() => {
            // 確保只隱藏當前訊息，而非被新訊息覆蓋的訊息
            if (userInfo.textContent === message) {
                userInfo.textContent = '狀態: 資料已儲存於您的瀏覽器中 (localStorage)'; 
                userInfo.classList.remove('text-rose-500', 'text-green-500');
                userInfo.classList.add('text-gray-500');
            }
        }, 5000);
    };

    /** 啟用/禁用 UI 元素 (在 LocalStorage 版本中，UI 始終啟用，此函數僅用於清理) */
    const toggleUIState = (ready) => {
        const addBtn = document.getElementById('add-event-btn');
        const saveBtn = document.getElementById('save-event-btn');

        // 在 LocalStorage 版本中，UI 始終處於啟用狀態
        addBtn.disabled = !ready;
        saveBtn.disabled = !ready;

        if (ready) {
            addBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            saveBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
    };


    // --- LocalStorage Operations ---

    /** 從 LocalStorage 載入所有行程 */
    const loadEventsFromLocalStorage = () => {
        try {
            const storedEvents = localStorage.getItem('calendarEvents');
            if (storedEvents) {
                // 從儲存的 JSON 字串解析回物件
                state.events = JSON.parse(storedEvents);
                console.log("Events loaded from localStorage.");
            } else {
                state.events = {};
                console.log("No events found in localStorage.");
            }
        } catch (e) {
            console.error("Error loading events from localStorage:", e);
            alertUser('載入失敗：無法從瀏覽器讀取資料。', true);
            state.events = {};
        }
        renderCalendar();
    };

    /** 將所有行程儲存到 LocalStorage */
    const saveEventsToLocalStorage = () => {
        try {
            // 將整個 events 狀態物件序列化為 JSON 字串
            localStorage.setItem('calendarEvents', JSON.stringify(state.events));
            console.log("Events saved to localStorage.");
        } catch (e) {
            console.error("Error saving events to localStorage:", e);
            alertUser('儲存失敗：瀏覽器儲存空間不足或設定禁止。', true);
        }
    };

    /** 新增或更新行程 (使用 LocalStorage) */
    const saveEvent = async (eventData, eventId = null) => {
        const { title, date, colorId } = eventData;
        
        // 1. 處理更新或移動邏輯
        if (eventId) {
            let found = false;
            let oldDateKey = null;

            // 遍歷尋找舊事件
            for (const key in state.events) {
                const eventIndex = state.events[key].findIndex(e => e.id === eventId);
                if (eventIndex !== -1) {
                    oldDateKey = key;
                    found = true;
                    
                    // 如果日期改變了，先從舊日期刪除
                    if (date !== oldDateKey) {
                        state.events[key].splice(eventIndex, 1);
                    } else {
                        // 日期沒變，直接更新
                        state.events[key][eventIndex].title = title;
                        state.events[key][eventIndex].colorId = colorId;
                    }
                    break;
                }
            }

            // 如果找到且日期有變，或舊事件不存在（防止錯誤）
            if (found && date !== oldDateKey || !found) {
                 const newEvent = { id: eventId, title, colorId, date };
                 if (!state.events[date]) state.events[date] = [];
                 state.events[date].push(newEvent);
                 alertUser('行程已更新！', false);
            } else if (found) {
                 alertUser('行程已更新！', false);
            } else {
                 alertUser('錯誤：找不到要更新的行程。', true);
            }
        } else {
            // 2. 處理新增邏輯
            const newEvent = {
                id: generateUniqueId(),
                title,
                date,
                colorId,
            };
            if (!state.events[date]) state.events[date] = [];
            state.events[date].push(newEvent);
            alertUser('行程新增成功！', false);
        }
        
        // 3. 清理空日期鍵
        Object.keys(state.events).forEach(key => {
            if (state.events[key].length === 0) {
                delete state.events[key];
            }
        });

        saveEventsToLocalStorage();
        renderCalendar();
        closeModal();
    };

    /** 刪除行程 (使用 LocalStorage) */
    const deleteEvent = async (eventId) => {
        let deleted = false;
        // 找到並移除事件
        for (const dateKey in state.events) {
            const initialLength = state.events[dateKey].length;
            // 篩選出 ID 不符合的事件，達到刪除效果
            state.events[dateKey] = state.events[dateKey].filter(event => event.id !== eventId);

            if (state.events[dateKey].length < initialLength) {
                deleted = true;
                // 如果該日期已無事件，則移除該日期鍵
                if (state.events[dateKey].length === 0) {
                    delete state.events[dateKey];
                }
                break;
            }
        }

        if (deleted) {
            saveEventsToLocalStorage();
            renderCalendar();
            alertUser('行程刪除成功！', false);
        }
    };

    // --- Calendar Rendering Logic ---

    /** 渲染日曆網格 */
    const renderCalendar = () => {
        const grid = document.getElementById('calendar-grid');
        const monthYearText = document.getElementById('current-month-year');
        grid.innerHTML = ''; // 清空網格

        const currentMonth = state.currentDate.getMonth();
        const currentYear = state.currentDate.getFullYear();
        monthYearText.textContent = `${currentYear}年 ${currentMonth + 1}月`;

        const firstDayOfMonth = new Date(currentYear, currentMonth, 1);
        const lastDayOfMonth = new Date(currentYear, currentMonth + 1, 0);
        const daysInMonth = lastDayOfMonth.getDate();
        let startingDay = firstDayOfMonth.getDay(); // 0 (Sun) to 6 (Sat)

        // 1. 填補上個月的空位
        for (let i = 0; i < startingDay; i++) {
            const emptyCell = document.createElement('div');
            emptyCell.className = 'empty-day day-cell border border-gray-100 bg-gray-50';
            grid.appendChild(emptyCell);
        }

        // 2. 渲染本月的日期
        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(currentYear, currentMonth, day);
            const dateKey = formatDate(date);
            const eventsOnDay = state.events[dateKey] || [];
            
            const cell = document.createElement('div');
            cell.className = 'day-cell border border-gray-100 p-2 flex flex-col justify-start items-start relative';
            
            // 標註今天
            if (formatDate(new Date()) === dateKey) {
                cell.classList.add('bg-blue-50', 'border-blue-300');
            }

            // 頂部日期數字
            const dateNumber = document.createElement('div');
            dateNumber.className = 'text-base font-semibold';
            dateNumber.textContent = day;
            cell.appendChild(dateNumber);

            // 事件列表
            const eventContainer = document.createElement('div');
            eventContainer.className = 'mt-1 w-full space-y-1';
            
            eventsOnDay.slice(0, 3).forEach(event => { // 最多顯示3個事件
                const color = COLORS.find(c => c.id === event.colorId) || COLORS.find(c => c.id === 'F');
                const eventTag = document.createElement('div');
                eventTag.className = `event-tag ${color.class} border`;
                eventTag.textContent = event.title;
                eventTag.title = event.title; // 完整標題提示
                eventTag.dataset.eventId = event.id;
                
                // 點擊事件只在 userId 存在時才綁定 openModal
                eventTag.addEventListener('click', (e) => {
                    e.stopPropagation(); // 防止點擊事件冒泡到日期格
                    openModal(event);
                });
                eventContainer.appendChild(eventTag);
            });
            
            if (eventsOnDay.length > 3) {
                const moreText = document.createElement('div');
                moreText.className = 'text-xs text-gray-500 mt-1';
                moreText.textContent = `+ ${eventsOnDay.length - 3} 個行程`;
                eventContainer.appendChild(moreText);
            }
            
            cell.appendChild(eventContainer);

            // 點擊日期格打開新增介面
            cell.addEventListener('click', () => {
                openModal(null, dateKey);
            });

            grid.appendChild(cell);
        }
    };

    /** 月份切換處理 */
    const changeMonth = (delta) => {
        state.currentDate.setMonth(state.currentDate.getMonth() + delta);
        renderCalendar();
    };

    // --- Modal Logic ---

    /** 打開行程 Modal */
    const openModal = (event = null, dateKey = null) => {
        const modal = document.getElementById('event-modal');
        const titleInput = document.getElementById('event-title');
        const dateInput = document.getElementById('event-date');
        const colorInput = document.getElementById('event-color');
        const modalTitle = document.getElementById('modal-title');
        const deleteBtn = document.getElementById('delete-event-btn');

        state.editingEventId = event ? event.id : null;

        // 1. 設定標題和刪除按鈕
        if (event) {
            modalTitle.textContent = '編輯行程';
            deleteBtn.classList.remove('hidden');
            // 點擊刪除按鈕時，打開自定義確認 Modal
            deleteBtn.onclick = () => {
                showDeleteConfirmModal(event.id);
            };
        } else {
            modalTitle.textContent = '新增行程';
            deleteBtn.classList.add('hidden');
        }

        // 2. 設定表單值
        const selectedDate = dateKey || (event ? event.date : formatDate(state.currentDate));
        titleInput.value = event ? event.title : '';
        dateInput.value = selectedDate;
        colorInput.value = event ? event.colorId : COLORS[0].id; // 預設第一個顏色

        // 3. 渲染顏色選擇器
        renderColorPicker(colorInput.value);

        // 4. 顯示 Modal
        modal.classList.remove('hidden');
        setTimeout(() => modal.style.opacity = '1', 10);
    };

    /** 關閉行程 Modal */
    const closeModal = () => {
        const modal = document.getElementById('event-modal');
        modal.style.opacity = '0';
        setTimeout(() => modal.classList.add('hidden'), 300);
        state.editingEventId = null;
    };

    /** 渲染顏色選擇器 */
    const renderColorPicker = (selectedColorId) => {
        const picker = document.getElementById('color-picker');
        const colorInput = document.getElementById('event-color');
        picker.innerHTML = '';

        COLORS.forEach(color => {
            const button = document.createElement('button');
            button.type = 'button';
            button.className = `w-10 h-10 rounded-full ${color.class} flex items-center justify-center border-2 transition`;
            button.title = color.name;
            button.dataset.colorId = color.id;
            
            if (color.id === selectedColorId) {
                // 視覺上標註選中
                button.classList.add('border-black', 'scale-110');
            } else {
                button.classList.add('border-transparent');
            }

            button.addEventListener('click', () => {
                colorInput.value = color.id;
                renderColorPicker(color.id); // 重新渲染以更新選中狀態
            });

            picker.appendChild(button);
        });
    };

    /** 顯示刪除確認 Modal */
    const showDeleteConfirmModal = (eventId) => {
        state.eventIdToDelete = eventId;
        closeModal(); // 關閉編輯 Modal
        const modal = document.getElementById('delete-confirm-modal');
        modal.classList.remove('hidden');
        setTimeout(() => modal.style.opacity = '1', 10);
    };

    /** 隱藏刪除確認 Modal */
    const hideDeleteConfirmModal = () => {
        const modal = document.getElementById('delete-confirm-modal');
        modal.style.opacity = '0';
        setTimeout(() => modal.classList.add('hidden'), 300);
        state.eventIdToDelete = null;
    };

    // --- Event Listeners ---

    const setupEventListeners = () => {
        // 月份切換
        document.getElementById('prev-month').addEventListener('click', () => changeMonth(-1));
        document.getElementById('next-month').addEventListener('click', () => changeMonth(1));

        // 新增事件按鈕
        document.getElementById('add-event-btn').addEventListener('click', () => {
            openModal(null, formatDate(new Date()));
        });
        
        // 關閉 Modal 按鈕
        document.getElementById('close-modal-btn').addEventListener('click', closeModal);

        // 點擊 Modal 外部關閉
        document.getElementById('event-modal').addEventListener('click', (e) => {
            if (e.target.id === 'event-modal') {
                closeModal();
            }
        });

        // --- 刪除確認 Modal 的監聽器 ---
        document.getElementById('cancel-delete-btn').addEventListener('click', hideDeleteConfirmModal);

        document.getElementById('confirm-delete-btn').addEventListener('click', () => {
            if (state.eventIdToDelete) {
                deleteEvent(state.eventIdToDelete);
                hideDeleteConfirmModal();
            }
        });

        document.getElementById('delete-confirm-modal').addEventListener('click', (e) => {
            if (e.target.id === 'delete-confirm-modal') {
                hideDeleteConfirmModal();
            }
        });
        // --- 結束 刪除確認 Modal 的監聽器 ---


        // 表單提交處理
        document.getElementById('event-form').addEventListener('submit', (e) => {
            e.preventDefault();

            const eventData = {
                title: document.getElementById('event-title').value.trim(),
                date: document.getElementById('event-date').value,
                colorId: document.getElementById('event-color').value,
            };

            if (eventData.title && eventData.date && eventData.colorId) {
                saveEvent(eventData, state.editingEventId);
            } else {
                alertUser('請填寫所有必填欄位。', true);
            }
        });
    };

    // --- Initialization ---

    /** 應用程式啟動 (不使用 Firebase) */
    window.onload = () => {
        console.log("App loaded. Using LocalStorage for persistence.");
        loadEventsFromLocalStorage(); // 從 LocalStorage 載入資料
        setupEventListeners();
        toggleUIState(true); // 始終啟用 UI
    };

</script>

</body>
</html>
